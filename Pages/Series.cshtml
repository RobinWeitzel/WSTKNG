@page "/series/{id?}"
@model SeriesModel
@{
    ViewData["Title"] = "Series";
}

<main>
    <form method="post">
        <input type="hidden" name="id" value="@Model.Series.ID" />
    </form>
    <div class="px-4 sm:px-6 lg:px-8">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-base font-semibold leading-6 text-gray-900">@Model.Series.Name</h1>
                <p class="mt-2 text-sm text-gray-700">A list of all the chapters found in the table of contents.</p>
            </div>
            <div class="mt-5 flex lg:ml-4 lg:mt-0 flex-col sm:flex-row">
                <span class="mb-3 sm:mb-0 sm:ml-3">
                    <a href="/series/@Model.Series.ID/settings" type="button"
                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"
                            aria-hidden="true">
                            <path
                                d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
                        </svg>
                        Settings
                    </a>
                </span>

                <span class="mb-3 sm:mb-0 sm:ml-3">
                    <button onclick="scanToc()" type="button"
                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"
                            aria-hidden="true">
                            <path fill-rule="evenodd"
                                d="M2.25 4.5A.75.75 0 0 1 3 3.75h14.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Zm14.47 3.97a.75.75 0 0 1 1.06 0l3.75 3.75a.75.75 0 1 1-1.06 1.06L18 10.81V21a.75.75 0 0 1-1.5 0V10.81l-2.47 2.47a.75.75 0 1 1-1.06-1.06l3.75-3.75ZM2.25 9A.75.75 0 0 1 3 8.25h9.75a.75.75 0 0 1 0 1.5H3A.75.75 0 0 1 2.25 9Zm0 4.5a.75.75 0 0 1 .75-.75h5.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Z"
                                clip-rule="evenodd" />
                        </svg>
                        Scan TOC
                    </button>
                </span>

                <span class="sm:ml-3">
                    <button onclick="openKindleModal()" type="button"
                        class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                            class="-ml-0.5 mr-1.5 h-5 w-5">
                            <path
                                d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
                        </svg>
                        Send to Kindle
                    </button>
                </span>
            </div>
        </div>

        <div class="-mx-4 mt-8 sm:-mx-0">
            <table class="min-w-full divide-y divide-gray-300">
                <thead>
                    <tr>
                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">
                            Title</th>
                        <th scope="col"
                            class="hidden px-3 py-3.5 text-left text-sm font-semibold text-gray-900 lg:table-cell">
                            Published</th>
                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Crawled</th>
                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Emailed</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    @foreach (var chapter in Model.Series.Chapters.OrderByDescending(c =>
                    c.Published).ThenByDescending(c
                    => c.Title))
                    {
                        <tr>
                            <td
                                class="w-full max-w-0 py-4 pl-4 pr-3 text-sm font-medium sm:w-auto sm:max-w-none sm:pl-0">
                                <a class="text-indigo-600 hover:text-indigo-900" href="@chapter.URL">@chapter.Title</a>
                                (<a class="text-indigo-600 hover:text-indigo-900" href="/series/@Model.Series.ID/chapter/@chapter.ID">view local</a>)
                                <dl class="font-normal lg:hidden">
                                    <dt class="sr-only">Published</dt>
                                    <dd class="mt-1 truncate text-gray-700">@chapter.Published.ToLocalTime()</dd>
                                </dl>
                            </td>
                            <td class="hidden px-3 py-4 text-sm text-gray-500 lg:table-cell">
                                @chapter.Published.ToLocalTime()</td>
                            <td class="px-3 py-4 text-sm text-gray-500">
                                <div class="flex items-center">
                                    <span>@(chapter.Crawled ? "Yes" : "No") </span>
                                    <button onclick="crawlChapter(@chapter.ID)" type="button"
                                        class="ml-1 text-indigo-600 hover:text-indigo-900">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15M9 12l3 3m0 0 3-3m-3 3V2.25" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                            <td class="px-3 py-4 text-sm text-gray-500">
                                <div class="flex items-center">
                                    <span>@(chapter.Sent ? "Yes" : "No")</span>
                                    <button onclick="sendChapter(@chapter.ID)" type="button"
                                        class="ml-1 text-indigo-600 hover:text-indigo-900">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>

    <!-- Kindle Modal -->
    <div id="kindleModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Send to Kindle</h3>
                <div class="space-y-4">
                    <div>
                        <label for="startChapter" class="block text-sm font-medium text-gray-700">Start Chapter</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" id="startChapter" min="1" max="@Model.Series.Chapters.Count" value="1" onchange="updateChapterTitles()"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <button type="button" onclick="setToOldestUnsent()" title="Set to oldest unsent chapter"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                                </svg>
                            </button>
                        </div>
                        <p id="startChapterTitle" class="mt-1 text-xs text-gray-600"></p>
                        <p id="startChapterStatus" class="mt-1 text-xs"></p>
                    </div>
                    <div>
                        <label for="endChapter" class="block text-sm font-medium text-gray-700">End Chapter</label>
                        <input type="number" id="endChapter" min="1" max="@Model.Series.Chapters.Count" value="@Model.Series.Chapters.Count" onchange="updateChapterTitles()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <p id="endChapterTitle" class="mt-1 text-xs text-gray-600"></p>
                        <p id="endChapterStatus" class="mt-1 text-xs"></p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p class="text-sm font-medium text-gray-700">Selection Summary:</p>
                        <p id="selectionSummary" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeKindleModal()"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" onclick="sendChapterRange()"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                        Send to Kindle
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        // Chapter data for title lookup (ordered oldest to newest)
        const chapters = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Series.Chapters
                .OrderBy(c => c.Published)
                .ThenBy(c => c.Title)
                .Select((c, index) => new { 
                    Number = index + 1, 
                    Title = c.Title,
                    Sent = c.Sent
                })
                .ToArray()
        ));

        const openKindleModal = () => {
            document.getElementById('kindleModal').classList.remove('hidden');
            updateChapterTitles(); // Initialize titles when modal opens
        }

        const closeKindleModal = () => {
            document.getElementById('kindleModal').classList.add('hidden');
        }

        const updateChapterTitles = () => {
            const startChapter = parseInt(document.getElementById('startChapter').value);
            const endChapter = parseInt(document.getElementById('endChapter').value);
            
            // Find chapter titles
            const startChapterData = chapters.find(c => c.Number === startChapter);
            const endChapterData = chapters.find(c => c.Number === endChapter);
            
            // Update title displays
            const startTitleElement = document.getElementById('startChapterTitle');
            const endTitleElement = document.getElementById('endChapterTitle');
            const startStatusElement = document.getElementById('startChapterStatus');
            const endStatusElement = document.getElementById('endChapterStatus');
            const summaryElement = document.getElementById('selectionSummary');
            
            if (startChapterData) {
                startTitleElement.textContent = `${startChapter}. ${startChapterData.Title}`;
                startTitleElement.className = 'mt-1 text-xs text-gray-600';
                
                // Show sent status
                startStatusElement.textContent = startChapterData.Sent ? 'Already sent' : 'Not sent yet';
                startStatusElement.className = startChapterData.Sent ? 'mt-1 text-xs text-green-600' : 'mt-1 text-xs text-blue-600';
            } else {
                startTitleElement.textContent = 'Chapter not found';
                startTitleElement.className = 'mt-1 text-xs text-red-600';
                startStatusElement.textContent = '';
            }
            
            if (endChapterData) {
                endTitleElement.textContent = `${endChapter}. ${endChapterData.Title}`;
                endTitleElement.className = 'mt-1 text-xs text-gray-600';
                
                // Show sent status
                endStatusElement.textContent = endChapterData.Sent ? 'Already sent' : 'Not sent yet';
                endStatusElement.className = endChapterData.Sent ? 'mt-1 text-xs text-green-600' : 'mt-1 text-xs text-blue-600';
            } else {
                endTitleElement.textContent = 'Chapter not found';
                endTitleElement.className = 'mt-1 text-xs text-red-600';
                endStatusElement.textContent = '';
            }
            
            // Update selection summary
            if (startChapterData && endChapterData && startChapter <= endChapter) {
                const chapterCount = endChapter - startChapter + 1;
                summaryElement.textContent = `Sending ${chapterCount} chapter${chapterCount === 1 ? '' : 's'} (${startChapter} to ${endChapter})`;
                summaryElement.className = 'text-sm text-gray-600 mt-1';
            } else {
                summaryElement.textContent = 'Invalid selection';
                summaryElement.className = 'text-sm text-red-600 mt-1';
            }
        }

        const setToOldestUnsent = () => {
            // Find the first (oldest) chapter that hasn't been sent yet
            const oldestUnsentChapter = chapters.find(c => !c.Sent);
            
            if (oldestUnsentChapter) {
                document.getElementById('startChapter').value = oldestUnsentChapter.Number;
            } else {
                // All chapters have been sent, set to newest chapter
                document.getElementById('startChapter').value = chapters.length;
            }
            updateChapterTitles(); // Update the display
        }

        const sendChapterRange = () => {
            const startChapter = parseInt(document.getElementById('startChapter').value);
            const endChapter = parseInt(document.getElementById('endChapter').value);
            
            if (startChapter > endChapter) {
                alert('Start chapter must be less than or equal to end chapter');
                return;
            }
            
            if (startChapter < 1 || endChapter < 1) {
                alert('Chapter numbers must be greater than 0');
                return;
            }

            const formData = new FormData();
            formData.append("id", @Model.Series.ID);
            formData.append("startChapter", startChapter);
            formData.append("endChapter", endChapter);
            formData.append("__RequestVerificationToken", document.querySelector('input[name="__RequestVerificationToken"]').value);

            fetch("/series/@Model.Series.ID?handler=range", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    storage.addId(data.jobId);
                    closeKindleModal();
                });
        }

        const scanToc = () => {
            const formData = new FormData();
            formData.append("id", @Model.Series.ID);

            fetch("/series/@Model.Series.ID?handler=scan", {
                method: "POST",
                body: formData,
                headers: {
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value,
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
                .then(response => response.json())
                .then(data => {
                    storage.addId(data.jobId);
                });
        }

        const crawlChapter = (id) => {
            const formData = new FormData();
            formData.append("id", id);

            fetch(`/series/${id}?handler=crawl`, {
                method: "POST",
                body: formData,
                headers: {
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value,
                    "Content-type": "application/json;"
                }
            })
                .then(response => response.json())
                .then(data => {
                    storage.addId(data.jobId);
                });
        }   

        const sendChapter = (id) => {
            const formData = new FormData();
            formData.append("id", id);

            fetch(`/series/${id}?handler=chapter`, {
                method: "POST",
                body: formData,
                headers: {
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value,
                    "Content-type": "application/json;"
                }
            })
                .then(response => response.json())
                .then(data => {
                    storage.addId(data.jobId);
                });
        }        
    </script>
}